<source>
  @type tail
  path /var/log/containers/*.log
  pos_file /mnt/pos/var-containers.log.pos
  time_format %Y-%m-%dT%H:%M:%S.%NZ
  tag containers.*
  format json
  read_from_head true
</source>

<source>
  @type tail
  path /mnt/log/containers/*.log
  pos_file /mnt/pos/mnt-containers.log.pos
  time_format %Y-%m-%dT%H:%M:%S.%NZ
  tag containers.*
  format json
  read_from_head true
</source>

<source>
  @type tail
  path /var/log/etc*.log
  pos_file /mnt/pos/var-etcd.log.pos
  tag admin.*
  format none
  encoding UTF-8
  read_from_head true
</source>

<source>
  @type tail
  path /var/log/kube-*.log
  pos_file /mnt/pos/mnt-kube.log.pos
  tag admin.*
  format none
  encoding UTF-8
  read_from_head true
</source>

<source>
  @type tail
  path /var/log/syslog
  pos_file /mnt/pos/mnt-syslog.log.pos
  tag admin.*
  format none
  encoding UTF-8
  read_from_head false
</source>

# Currently using old version of grep filter (only allows 1 key per filter)
# Need to upgrade fluentd to use <regexp></regexp> syntax
# Only keep RBAC DENY logs or ERRORS
<filter admin.var.log.kube-apiserver.log>
  @type grep
  regexp1 message (^.*RBAC DENY:.*$|^E[0-9]{4} .*$)
</filter>

# Only keep AUDIT logs
<filter admin.var.log.kube-apiserver-audit.log>
  @type grep
  regexp1 message ^.*AUDIT:.*$
</filter>

# tag RBAC DENY messages for metrics
<match admin.var.log.kube-apiserver.log>
  @type rewrite_tag_filter
  <rule>
    key     message
    pattern ^.*RBAC DENY:.*$
    tag metrics.rbac
  </rule>
</match>

# Add numeric increment field for counting
<filter metrics.**>
  @type record_transformer
  enable_ruby
  auto_typecast
  <record>
    increment ${1}
  </record>
</filter>

<filter metrics.rbac>
  @type prometheus
  <metric>
    name message_rbac_deny_counter
    type counter
    desc The total number of rbac deny messages
    key increment
  </metric>
</filter>

<filter **>
  @type record_transformer
  <record>
    k8ssource ${hostname}.${tag}
    cluster "#{ENV['CLUSTER_NAME']}"
  </record>
</filter>

<filter fluent.**>
  @type stdout
</filter>

<filter containers.**>
  @type kubernetes_metadata
</filter>

<filter containers.**>
  @type record_transformer
  enable_ruby true
  <record>
    k8ssource ${record['kubernetes']['namespace_name']}.${record['kubernetes']['pod_name']}.${record['kubernetes']['container_name']}
  </record>
</filter>

<match **>
  @type cloudwatch_logs
  log_group_name "#{ENV['CLUSTER_NAME']}"
  auto_create_stream true
  max_events_per_batch 5000
  log_stream_name_key k8ssource
</match>
